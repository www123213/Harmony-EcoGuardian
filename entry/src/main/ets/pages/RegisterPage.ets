import { AuthService } from '../service/AuthService';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct RegisterPage {
  @State username: string = '';
  @State email: string = '';
  @State password: string = '';
  @State confirmPassword: string = '';
  @State isLoading: boolean = false;
  private authService: AuthService = AuthService.getInstance();

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .backgroundColor(Color.Transparent)
          .fontColor('#333')
          .onClick(() => {
            router.back();
          })
        
        Blank()
        
        Text('æ³¨å†Œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Text('')
          .width(60)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      Scroll() {
        // æ³¨å†Œè¡¨å•
        Column({ space: 20 }) {
          // Logo
          Column({ space: 10 }) {
            Text('ğŸŒ±')
              .fontSize(80)
            Text('åŠ å…¥æˆ‘ä»¬')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2E7D32')
            Text('å¼€å§‹ä½ çš„ç¯ä¿ä¹‹æ—…')
              .fontSize(16)
              .fontColor('#666')
          }
          .margin({ top: 40, bottom: 30 })

          // ç”¨æˆ·åè¾“å…¥
          Column({ space: 8 }) {
            Text('ç”¨æˆ·å')
              .fontSize(14)
              .fontColor('#333')
              .alignSelf(ItemAlign.Start)
            
            TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰' })
              .width('100%')
              .height(50)
              .backgroundColor('#f8f8f8')
              .borderRadius(8)
              .padding({ left: 16, right: 16 })
              .onChange((value: string) => {
                this.username = value;
              })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          // é‚®ç®±è¾“å…¥
          Column({ space: 8 }) {
            Text('é‚®ç®±')
              .fontSize(14)
              .fontColor('#333')
              .alignSelf(ItemAlign.Start)
            
            TextInput({ placeholder: 'è¯·è¾“å…¥é‚®ç®±åœ°å€' })
              .width('100%')
              .height(50)
              .backgroundColor('#f8f8f8')
              .borderRadius(8)
              .padding({ left: 16, right: 16 })
              .type(InputType.Email)
              .onChange((value: string) => {
                this.email = value;
              })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          // å¯†ç è¾“å…¥
          Column({ space: 8 }) {
            Text('å¯†ç ')
              .fontSize(14)
              .fontColor('#333')
              .alignSelf(ItemAlign.Start)
            
            TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½å­—ç¬¦ï¼‰' })
              .width('100%')
              .height(50)
              .backgroundColor('#f8f8f8')
              .borderRadius(8)
              .padding({ left: 16, right: 16 })
              .type(InputType.Password)
              .onChange((value: string) => {
                this.password = value;
              })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          // ç¡®è®¤å¯†ç è¾“å…¥
          Column({ space: 8 }) {
            Text('ç¡®è®¤å¯†ç ')
              .fontSize(14)
              .fontColor('#333')
              .alignSelf(ItemAlign.Start)
            
            TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ' })
              .width('100%')
              .height(50)
              .backgroundColor('#f8f8f8')
              .borderRadius(8)
              .padding({ left: 16, right: 16 })
              .type(InputType.Password)
              .onChange((value: string) => {
                this.confirmPassword = value;
              })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          // æ³¨å†ŒæŒ‰é’®
          Button(this.isLoading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ')
            .width('100%')
            .height(50)
            .backgroundColor('#4CAF50')
            .borderRadius(25)
            .fontSize(18)
            .fontColor('#fff')
            .enabled(!this.isLoading)
            .onClick(() => {
              this.handleRegister()
            })

          // ç™»å½•é“¾æ¥
          Row() {
            Text('å·²æœ‰è´¦å·ï¼Ÿ')
              .fontSize(14)
              .fontColor('#666')
            
            Text('ç«‹å³ç™»å½•')
              .fontSize(14)
              .fontColor('#4CAF50')
              .onClick(() => {
                router.replaceUrl({ url: 'pages/LoginPage' });
              })
          }
          .margin({ top: 20 })

          // ç¯ä¿æ‰¿è¯º
          Column({ space: 10 }) {
            Text('ğŸŒ ç¯ä¿æ‰¿è¯º')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#4CAF50')
            Text('æ³¨å†Œå³è¡¨ç¤ºæ‚¨æ„¿æ„å‚ä¸ç¯ä¿è¡ŒåŠ¨ï¼Œä¸ºåœ°çƒç¯å¢ƒè´¡çŒ®ä¸€ä»½åŠ›é‡')
              .fontSize(12)
              .fontColor('#666')
              .textAlign(TextAlign.Center)
          }
          .width('100%')
          .padding(15)
          .backgroundColor('#E8F5E8')
          .borderRadius(8)
          .margin({ top: 20 })
        }
        .width('100%')
        .padding({ left: 30, right: 30, bottom: 30 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  async handleRegister() {
    // éªŒè¯è¾“å…¥
    if (!this.username.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥ç”¨æˆ·å' })
      return
    }

    if (this.username.trim().length < 2) {
      promptAction.showToast({ message: 'ç”¨æˆ·åè‡³å°‘2ä¸ªå­—ç¬¦' })
      return
    }

    if (!this.email.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥é‚®ç®±' })
      return
    }

    if (!this.password.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¯†ç ' })
      return
    }

    if (this.password.length < 6) {
      promptAction.showToast({ message: 'å¯†ç è‡³å°‘6ä½å­—ç¬¦' })
      return
    }

    if (this.password !== this.confirmPassword) {
      promptAction.showToast({ message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´' })
      return
    }

    this.isLoading = true;

    try {
      const result = await this.authService.register(
        this.username.trim(),
        this.email.trim(),
        this.password
      )
      
      if (result.success) {
        promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸï¼Œæ­£åœ¨ç™»å½•...' })
        
        // æ·»åŠ å»¶è¿Ÿç¡®ä¿æ•°æ®å·²å®Œå…¨ä¿å­˜
        await new Promise<void>((resolve) => setTimeout(resolve, 1000))
        
        // è‡ªåŠ¨ç™»å½•
        const loginResult = await this.authService.login(this.email.trim(), this.password)
        if (loginResult.success) {
          promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' })
          // è¿”å›ä¸»é¡µ
          router.replaceUrl({ url: 'pages/Index' })
        } else {
          console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥:', loginResult.message)
          // æ³¨å†ŒæˆåŠŸä½†ç™»å½•å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          promptAction.showToast({ message: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·æ‰‹åŠ¨ç™»å½•' })
          router.replaceUrl({ url: 'pages/LoginPage' })
        }
      } else {
        promptAction.showToast({ message: result.message })
      }
    } catch (error) {
      console.error('æ³¨å†Œå¤±è´¥:', error)
      promptAction.showToast({ message: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•' })
    } finally {
      this.isLoading = false;
    }
  }
}