import { DataService } from '../service/DataService';
import { EcoKnowledge } from '../model/User';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct KnowledgePage {
  @State knowledgeList: EcoKnowledge[] = [];
  @State selectedCategory: string = 'å…¨éƒ¨';
  @State isLoading: boolean = true;
  @State searchKeyword: string = '';
  
  private dataService: DataService = DataService.getInstance();
  private categories: string[] = ['å…¨éƒ¨', 'åƒåœ¾åˆ†ç±»', 'èŠ‚çº¦ç”¨æ°´', 'ä½ç¢³å‡ºè¡Œ', 'èŠ‚èƒ½å‡æ’', 'ç»¿è‰²ç”Ÿæ´»'];

  async aboutToAppear() {
    await this.loadKnowledgeData();
  }

  async onPageShow() {
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½æœ€æ–°æ•°æ®
    await this.loadKnowledgeData();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .backgroundColor(Color.Transparent)
          .fontColor('#333')
          .onClick(() => {
            router.back();
          })
        
        Blank()
        
        Text('ç¯ä¿çŸ¥è¯†')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text('')
          .width(60)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      Column() {
        // æœç´¢æ¡†
        Row() {
          TextInput({ placeholder: 'æœç´¢ç¯ä¿çŸ¥è¯†...' })
            .layoutWeight(1)
            .height(40)
            .backgroundColor('#f0f0f0')
            .borderRadius(20)
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.searchKeyword = value
            })
          
          Button(){
            Text('ğŸ”')
              .fontSize(25)
          }
            .width(40)
            .height(40)
            .backgroundColor('#4CAF50')
            .borderRadius(20)
            .margin({ left: 10 })
            .onClick(() => {
              this.filterKnowledge()
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 10, bottom: 10 })

        // åˆ†ç±»æ ‡ç­¾
        Scroll() {
          Row({ space: 10 }) {
            ForEach(this.categories, (category: string) => {
              Text(category)
                .fontSize(14)
                .fontColor(this.selectedCategory === category ? '#fff' : '#333')
                .backgroundColor(this.selectedCategory === category ? '#4CAF50' : '#f0f0f0')
                .padding({ top: 6, bottom: 6, left: 12, right: 12 })
                .borderRadius(15)
                .onClick(() => {
                  this.selectedCategory = category;
                  this.filterKnowledge()
                })
            })
          }
          .padding({ left: 16, right: 16 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
        .height(40)

        // çŸ¥è¯†åˆ—è¡¨
        if (this.isLoading) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#666')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        } else {
          List({ space: 10 }) {
            ForEach(this.getFilteredKnowledge(), (knowledge: EcoKnowledge) => {
              ListItem() {
                this.buildKnowledgeItem(knowledge)
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, bottom: 16 })
        }

        // åº•éƒ¨æç¤º
        Row() {
          Text('ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ–‡ç« å¯æŸ¥çœ‹è¯¦ç»†å†…å®¹')
            .fontSize(12)
            .fontColor('#999')
        }
        .width('100%')
        .padding(10)
        .backgroundColor('#f8f8f8')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder buildKnowledgeItem(knowledge: EcoKnowledge) {
    Column({ space: 10 }) {
      // æ ‡é¢˜å’Œåˆ†ç±»
      Row() {
        Text(knowledge.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
        
        Text(knowledge.category)
          .fontSize(12)
          .fontColor('#4CAF50')
          .backgroundColor('#E8F5E8')
          .padding({ top: 4, bottom: 4, left: 8, right: 8 })
          .borderRadius(10)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      // å†…å®¹é¢„è§ˆ
      Text(knowledge.content)
        .fontSize(14)
        .fontColor('#666')
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .lineHeight(20)

      // åº•éƒ¨ä¿¡æ¯
      Row() {
        Text(`æ¥æºï¼š${knowledge.source}`)
          .fontSize(12)
          .fontColor('#999')
        
        Blank()
        
        Row({ space: 15 }) {
          Row({ space: 4 }) {
            Text('ğŸ‘')
              .fontSize(12)
            Text(knowledge.views.toString())
              .fontSize(12)
              .fontColor('#999')
          }
          
          Row({ space: 4 }) {
            Text('ğŸ‘')
              .fontSize(12)
            Text(knowledge.likes.toString())
              .fontSize(12)
              .fontColor('#999')
          }
        }
      }
      .width('100%')

      // å‘å¸ƒæ—¶é—´
      Text(this.formatDate(knowledge.publishDate))
        .fontSize(12)
        .fontColor('#ccc')
        .alignSelf(ItemAlign.End)
    }
    .width('100%')
    .padding(15)
    .backgroundColor('#fff')
    .borderRadius(10)
    .onClick(() => {
      this.viewKnowledgeDetail(knowledge)
    })
  }

  private async loadKnowledgeData() {
    try {
      // åˆå§‹åŒ–æ•°æ®æœåŠ¡
      await this.dataService.init(getContext(this))
      
      this.knowledgeList = await this.dataService.getEcoKnowledgeList()
      
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¹±ç æ•°æ®
      const hasCorruptedData = this.knowledgeList.some(item => 
        !item.title || item.title.length > 100 || /^[0-9a-f]{10,}/.test(item.title) ||
        !item.content || item.content.length < 10
      );
      
      if (hasCorruptedData) {
        console.log('æ£€æµ‹åˆ°ç¯ä¿çŸ¥è¯†ä¹±ç æ•°æ®ï¼Œæ­£åœ¨æ¸…ç†...');
        await this.dataService.clearCorruptedKnowledgeData();
        await this.dataService.initSampleData();
        this.knowledgeList = await this.dataService.getEcoKnowledgeList();
      }
      
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ æ›´å¤šç¤ºä¾‹æ•°æ®
      if (this.knowledgeList.length === 0) {
        await this.addMoreSampleKnowledge()
        this.knowledgeList = await this.dataService.getEcoKnowledgeList()
      }
    } catch (error) {
      console.error('åŠ è½½ç¯ä¿çŸ¥è¯†å¤±è´¥:', error)
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•' })
    } finally {
      this.isLoading = false;
    }
  }

  private async addMoreSampleKnowledge() {
    const moreKnowledge = [
      new EcoKnowledge(
        'å¦‚ä½•æ­£ç¡®è¿›è¡Œåƒåœ¾åˆ†ç±»',
        'åƒåœ¾åˆ†ç±»æ˜¯ç¯ä¿çš„é‡è¦ä¸€ç¯ã€‚å¯å›æ”¶ç‰©åŒ…æ‹¬åºŸçº¸ã€åºŸå¡‘æ–™ã€åºŸé‡‘å±ã€åºŸç»ç’ƒç­‰ï¼›æœ‰å®³åƒåœ¾åŒ…æ‹¬åºŸç”µæ± ã€åºŸç¯ç®¡ã€åºŸè¯å“ç­‰ï¼›æ¹¿åƒåœ¾æ˜¯æ˜“è…çƒ‚çš„ç”Ÿç‰©è´¨åºŸæ–™ï¼›å¹²åƒåœ¾æ˜¯é™¤ä¸Šè¿°ä¸‰ç±»ä¹‹å¤–çš„å…¶ä»–åƒåœ¾ã€‚æ­£ç¡®åˆ†ç±»å¯ä»¥æé«˜èµ„æºå›æ”¶åˆ©ç”¨ç‡ï¼Œå‡å°‘ç¯å¢ƒæ±¡æŸ“ã€‚',
        'åƒåœ¾åˆ†ç±»',
        'ç¯ä¿éƒ¨é—¨'
      ),
      new EcoKnowledge(
        'å®¶åº­èŠ‚èƒ½å‡æ’å°å¦™æ‹›',
        '1.ä½¿ç”¨LEDç¯æ³¡ï¼Œæ¯”ä¼ ç»Ÿç™½ç‚½ç¯èŠ‚èƒ½80%ï¼›2.åˆç†è®¾ç½®ç©ºè°ƒæ¸©åº¦ï¼Œå¤å­£26â„ƒï¼Œå†¬å­£20â„ƒï¼›3.åŠæ—¶å…³é—­ä¸ç”¨çš„ç”µå™¨ï¼›4.ä½¿ç”¨èŠ‚èƒ½å®¶ç”µï¼›5.å……åˆ†åˆ©ç”¨è‡ªç„¶å…‰ï¼›6.å®šæœŸæ¸…æ´ç©ºè°ƒæ»¤ç½‘ã€‚è¿™äº›å°ä¹ æƒ¯èƒ½æ˜¾è‘—é™ä½å®¶åº­ç¢³æ’æ”¾ã€‚',
        'èŠ‚èƒ½å‡æ’',
        'èŠ‚èƒ½åä¼š'
      ),
      new EcoKnowledge(
        'ç»¿è‰²å‡ºè¡Œçš„å¤šç§é€‰æ‹©',
        'ç»¿è‰²å‡ºè¡Œä¸ä»…ç¯ä¿ï¼Œè¿˜æœ‰ç›Šå¥åº·ã€‚æ­¥è¡Œé€‚åˆçŸ­è·ç¦»å‡ºè¡Œï¼Œæ—¢é”»ç‚¼èº«ä½“åˆé›¶æ’æ”¾ï¼›è‡ªè¡Œè½¦å‡ºè¡Œçµæ´»ä¾¿æ·ï¼Œé€‚åˆä¸­çŸ­è·ç¦»ï¼›å…¬å…±äº¤é€šäººå‡ç¢³æ’æ”¾ä½ï¼›ç”µåŠ¨æ±½è½¦æ¯”ç‡ƒæ²¹è½¦å‡æ’50%ä»¥ä¸Šï¼›æ‹¼è½¦å‡ºè¡Œå¯ä»¥å‡å°‘é“è·¯æ‹¥å µå’Œæ’æ”¾ã€‚',
        'ä½ç¢³å‡ºè¡Œ',
        'äº¤é€šè¿è¾“éƒ¨'
      ),
      new EcoKnowledge(
        'å¡‘æ–™æ±¡æŸ“ä¸å‡å¡‘è¡ŒåŠ¨',
        'å¡‘æ–™æ±¡æŸ“å·²æˆä¸ºå…¨çƒç¯å¢ƒé—®é¢˜ã€‚å‡å¡‘ä»æ—¥å¸¸åšèµ·ï¼šä½¿ç”¨å¯é‡å¤è´­ç‰©è¢‹ï¼›é€‰æ‹©ç»ç’ƒæˆ–ä¸é”ˆé’¢æ°´ç“¶ï¼›é¿å…ä¸€æ¬¡æ€§é¤å…·ï¼›é€‰æ‹©åŒ…è£…ç®€å•çš„å•†å“ï¼›å‚ä¸å¡‘æ–™å›æ”¶ï¼›æ”¯æŒå¯é™è§£ææ–™ã€‚æ¯ä¸ªäººçš„å°è¡ŒåŠ¨æ±‡èšæˆä¿æŠ¤åœ°çƒçš„å¤§åŠ›é‡ã€‚',
        'ç»¿è‰²ç”Ÿæ´»',
        'ç¯ä¿ç»„ç»‡'
      ),
      new EcoKnowledge(
        'åŸå¸‚ç»¿åŒ–çš„é‡è¦æ„ä¹‰',
        'åŸå¸‚ç»¿åŒ–ä¸ä»…ç¾åŒ–ç¯å¢ƒï¼Œæ›´æœ‰é‡è¦çš„ç”Ÿæ€åŠŸèƒ½ã€‚æ ‘æœ¨èƒ½å¸æ”¶äºŒæ°§åŒ–ç¢³ï¼Œé‡Šæ”¾æ°§æ°”ï¼›è°ƒèŠ‚åŸå¸‚æ¸©åº¦ï¼Œç¼“è§£çƒ­å²›æ•ˆåº”ï¼›å‡€åŒ–ç©ºæ°”ï¼Œå¸é™„ç²‰å°˜ï¼›æ¶µå…»æ°´æºï¼Œé˜²æ­¢æ°´åœŸæµå¤±ï¼›ä¸ºé‡ç”ŸåŠ¨ç‰©æä¾›æ –æ¯åœ°ã€‚æ¯æ£µæ ‘éƒ½æ˜¯åŸå¸‚çš„ç»¿è‰²å«å£«ã€‚',
        'ç»¿è‰²ç”Ÿæ´»',
        'åŸå¸‚è§„åˆ’å±€'
      )
    ]

    for (const knowledge of moreKnowledge) {
      await this.dataService.saveEcoKnowledge(knowledge)
    }
  }

  private getFilteredKnowledge(): EcoKnowledge[] {
    let filtered = this.knowledgeList

    // æŒ‰åˆ†ç±»è¿‡æ»¤
    if (this.selectedCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(item => item.category === this.selectedCategory);
    }

    // æŒ‰å…³é”®è¯è¿‡æ»¤
    if (this.searchKeyword.trim()) {
      const keyword = this.searchKeyword.trim().toLowerCase()
      filtered = filtered.filter(item => 
        item.title.toLowerCase().includes(keyword) || 
        item.content.toLowerCase().includes(keyword)
      )
    }

    // æŒ‰å‘å¸ƒæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    return filtered.sort((a, b) => b.publishDate.getTime() - a.publishDate.getTime())
  }

  private filterKnowledge() {
    // è§¦å‘é‡æ–°æ¸²æŸ“
    this.knowledgeList = [...this.knowledgeList]
  }


  private viewKnowledgeDetail(knowledge: EcoKnowledge) {
    // å¢åŠ æµè§ˆé‡
    knowledge.addView();

    // ä¿å­˜æµè§ˆé‡å¢åŠ 
    this.dataService.saveEcoKnowledge(knowledge).then(() => {
      // æ‰¾åˆ°æœ€æ–°æ•°æ®ä¸­çš„çŸ¥è¯†æ¡ç›®
      const index = this.knowledgeList.findIndex(k => k.id === knowledge.id);
      if (index !== -1) {
        // æ›´æ–°æœ¬åœ°åˆ—è¡¨ä¸­çš„æ•°æ®
        this.knowledgeList[index] = knowledge;
        // è§¦å‘UIæ›´æ–°
        this.knowledgeList = [...this.knowledgeList];
      }

      // æ˜¾ç¤ºè¯¦ç»†å†…å®¹
      promptAction.showDialog({
        title: knowledge.title,
        message: knowledge.content,
        buttons: [
          {
            text: 'ç‚¹èµ',
            color: '#4CAF50'
          },
          {
            text: 'å…³é—­',
            color: '#666'
          }
        ]
      }).then((result) => {
        if (result.index === 0) {
          // ç‚¹èµ
          knowledge.addLike();
          this.dataService.saveEcoKnowledge(knowledge).then(() => {
            // æ›´æ–°æœ¬åœ°åˆ—è¡¨ä¸­çš„æ•°æ®
            const updatedIndex = this.knowledgeList.findIndex(k => k.id === knowledge.id);
            if (updatedIndex !== -1) {
              this.knowledgeList[updatedIndex] = knowledge;
              // è§¦å‘UIæ›´æ–°
              this.knowledgeList = [...this.knowledgeList];
            }
            promptAction.showToast({ message: 'ç‚¹èµæˆåŠŸï¼' });
          });
        }
      });
    });
  }

  private formatDate(date: Date): string {
    const now = new Date()
    const diff = now.getTime() - date.getTime()
    const days = Math.floor(diff / (1000 * 60 * 60 * 24))
    
    if (days === 0) {
      return 'ä»Šå¤©'
    } else if (days === 1) {
      return 'æ˜¨å¤©'
    } else if (days < 7) {
      return `${days}å¤©å‰`
    } else {
      return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
    }
  }
}