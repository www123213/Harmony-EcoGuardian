import { DataService } from '../service/DataService';
import { AuthService } from '../service/AuthService';
import { CarbonCalculator } from '../service/CarbonCalculator';
import { User, EcoRecord } from '../model/User';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
export struct ProfilePage {
  @State currentUser: User | null = null;
  @State userRecords: EcoRecord[] = [];
  @State isLoading: boolean = true;
  @State showLogoutDialog: boolean = false;
  @State showEditDialog: boolean = false;
  @State editUsername: string = '';
  @State editAvatar: string = '';
  
  private dataService: DataService = DataService.getInstance();
  private authService: AuthService = AuthService.getInstance();
  private carbonCalculator: CarbonCalculator = CarbonCalculator.getInstance();
  private avatarOptions: string[] = ['ğŸŒ±', 'ğŸŒ¿', 'ğŸŒ³', 'ğŸŒ²', 'ğŸƒ', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸŒ¹'];

  async aboutToAppear() {
    await this.loadUserData();
    // åˆå§‹åŒ–AppStorage
    AppStorage.SetOrCreate('userDataUpdated', 0);
  }

  async onPageShow() {
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶å¼ºåˆ¶é‡æ–°åŠ è½½æœ€æ–°æ•°æ®
    this.isLoading = true;
    await this.loadUserData(true);
  }

  build() {
    Column() {
      if (this.isLoading) {
        Column() {
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#666')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.currentUser) {
        this.buildProfileContent()
      } else {
        this.buildLoginPrompt()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder buildProfileContent() {
    Scroll() {
      Column({ space: 16 }) {
        // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
        this.buildUserInfoCard()
        
        // ç»Ÿè®¡æ•°æ®å¡ç‰‡
        this.buildStatsCard()
        
        // å‹‹ç« å±•ç¤º
        this.buildBadgesCard()
        
        // åŠŸèƒ½èœå•
        this.buildMenuCard()
        
        // é€€å‡ºç™»å½•æŒ‰é’®
        Button('é€€å‡ºç™»å½•')
          .width('100%')
          .height(48)
          .backgroundColor('#FF5722')
          .fontColor('#fff')
          .fontSize(16)
          .borderRadius(8)
          .onClick(() => {
            this.showLogoutDialog = true
          })
      }
      .padding(16)
    }
    .layoutWeight(1)
    
    // é€€å‡ºç™»å½•ç¡®è®¤å¯¹è¯æ¡†
    if (this.showLogoutDialog) {
      this.buildLogoutDialog()
    }
    
    // ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯å¯¹è¯æ¡†
    if (this.showEditDialog) {
      this.buildEditDialog()
    }
  }

  @Builder buildUserInfoCard() {
    Column({ space: 15 }) {
      Row() {
        // å¤´åƒ
        Text(this.currentUser?.avatar || 'ğŸŒ±')
          .fontSize(50)
          .width(80)
          .height(80)
          .backgroundColor('#E8F5E8')
          .borderRadius(40)
          .textAlign(TextAlign.Center)
          .onClick(() => {
            this.editUsername = this.currentUser?.username || ''
            this.editAvatar = this.currentUser?.avatar || 'ğŸŒ±'
            this.showEditDialog = true
          })
        
        Column({ space: 8 }) {
          Text(this.currentUser?.username || '')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
          
          Text(`ç­‰çº§ ${this.currentUser?.level || 1}`)
            .fontSize(14)
            .fontColor('#4CAF50')
            .backgroundColor('#E8F5E8')
            .padding({ top: 4, bottom: 4, left: 8, right: 8 })
            .borderRadius(12)
          
          Text(this.currentUser?.email || '')
            .fontSize(12)
            .fontColor('#666')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 15 })
        
        Button('ç¼–è¾‘')
          .backgroundColor('#4CAF50')
          .fontColor('#fff')
          .fontSize(12)
          .padding({ top: 6, bottom: 6, left: 12, right: 12 })
          .borderRadius(15)
          .onClick(() => {
            this.editUsername = this.currentUser?.username || ''
            this.editAvatar = this.currentUser?.avatar || 'ğŸŒ±'
            this.showEditDialog = true
          })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      
      // åŠ å…¥æ—¶é—´
      Text(`åŠ å…¥æ—¶é—´ï¼š${this.formatDate(this.currentUser?.createdAt || '')}`)
        .fontSize(12)
        .fontColor('#999')
        .alignSelf(ItemAlign.Start)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#fff')
    .borderRadius(12)
  }

  @Builder buildStatsCard() {
    Column({ space: 15 }) {
      Text('æˆ‘çš„ç¯ä¿æ•°æ®')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .alignSelf(ItemAlign.Start)
      
      Row() {
        this.buildStatItem('æ€»ç§¯åˆ†', (this.currentUser?.points || 0).toString(), '#FF9800')
        this.buildStatItem('å‡æ’é‡', this.carbonCalculator.formatCarbonReduction(this.currentUser?.carbonReduction || 0), '#4CAF50')
        this.buildStatItem('è®°å½•æ•°', this.userRecords.length.toString(), '#2196F3')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      
      Row() {
        this.buildStatItem('å‹‹ç« æ•°', (this.currentUser?.badges.length || 0).toString(), '#9C27B0')
        this.buildStatItem('ç­‰çº§', `Lv.${this.currentUser?.level || 1}`, '#607D8B')
        this.buildStatItem('æ’å', this.getUserRanking(), '#E91E63')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#fff')
    .borderRadius(12)
  }

  @Builder buildStatItem(label: string, value: string, color: string) {
    Column({ space: 5 }) {
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      Text(label)
        .fontSize(12)
        .fontColor('#666')
    }
    .alignItems(HorizontalAlign.Center)
    .layoutWeight(1)
  }

  @Builder buildBadgesCard() {
    Column({ space: 15 }) {
      Row() {
        Text('æˆ‘çš„å‹‹ç« ')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text(`${this.currentUser?.badges.length || 0}/10`)
          .fontSize(12)
          .fontColor('#666')
      }
      .width('100%')
      
      if (this.currentUser?.badges && this.currentUser.badges.length > 0) {
        Grid() {
          ForEach(this.currentUser.badges.slice(0, 6), (badge: string) => {
            GridItem() {
              Column({ space: 4 }) {
                Text(this.getBadgeIcon(badge))
                  .fontSize(24)
                Text(badge)
                  .fontSize(10)
                  .fontColor('#333')
                  .textAlign(TextAlign.Center)
                  .maxLines(1)
              }
              .width('100%')
              .padding(8)
              .backgroundColor('#E8F5E8')
              .borderRadius(8)
            }
          })
          
          if (this.currentUser.badges.length > 6) {
            GridItem() {
              Column({ space: 4 }) {
                Text('+')
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                Text(`${this.currentUser.badges.length - 6}ä¸ª`)
                  .fontSize(10)
                  .fontColor('#666')
              }
              .width('100%')
              .padding(8)
              .backgroundColor('#f0f0f0')
              .borderRadius(8)
              .onClick(() => {
                router.pushUrl({ url: 'pages/RankingPage' })
              })
            }
          }
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
      } else {
        Text('æš‚æ— å‹‹ç« ï¼Œå¿«å»å‚ä¸ç¯ä¿æ´»åŠ¨è·å¾—å‹‹ç« å§ï¼')
          .fontSize(12)
          .fontColor('#999')
          .textAlign(TextAlign.Center)
          .padding(20)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#fff')
    .borderRadius(12)
  }

  @Builder buildMenuCard() {
    Column() {
      this.buildMenuItem('ğŸ“Š', 'æˆ‘çš„è®°å½•', 'æŸ¥çœ‹ç¯ä¿è®°å½•è¯¦æƒ…', () => {
        // è·³è½¬åˆ°è®°å½•é¡µé¢
        router.pushUrl({ url: 'pages/RecordPage'})
      })
      
      Divider().color('#f0f0f0')
      
      this.buildMenuItem('ğŸ†', 'æ’è¡Œæ¦œ', 'æŸ¥çœ‹ç§¯åˆ†å’Œå‡æ’æ’å', () => {
        router.pushUrl({ url: 'pages/RankingPage' })
      })
      
      Divider().color('#f0f0f0')
      
      this.buildMenuItem('ğŸ“š', 'ç¯ä¿çŸ¥è¯†', 'å­¦ä¹ ç¯ä¿å°çŸ¥è¯†', () => {
        router.pushUrl({ url: 'pages/KnowledgePage' })
      })
      
      Divider().color('#f0f0f0')
      
      this.buildMenuItem('âš™ï¸', 'è®¾ç½®', 'åº”ç”¨è®¾ç½®å’Œåå¥½', () => {
        promptAction.showToast({ message: 'è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...' })
      })
      
      Divider().color('#f0f0f0')
      
      this.buildMenuItem('â“', 'å¸®åŠ©ä¸åé¦ˆ', 'è·å–å¸®åŠ©æˆ–æä¾›åé¦ˆ', () => {
        promptAction.showToast({ message: 'å¸®åŠ©åŠŸèƒ½å¼€å‘ä¸­...' })
      })
    }
    .width('100%')
    .backgroundColor('#fff')
    .borderRadius(12)
  }

  @Builder buildMenuItem(icon: string, title: string, subtitle: string, onClick: () => void) {
    Row() {
      Text(icon)
        .fontSize(20)
        .width(40)
      
      Column({ space: 4 }) {
        Text(title)
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .alignSelf(ItemAlign.Start)
        Text(subtitle)
          .fontSize(12)
          .fontColor('#666')
          .alignSelf(ItemAlign.Start)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 10 })
      
      Text('>')
        .fontSize(16)
        .fontColor('#ccc')
    }
    .width('100%')
    .padding(15)
    .onClick(onClick)
  }

  @Builder buildLoginPrompt() {
    Column({ space: 20 }) {
      Text('ğŸŒ±')
        .fontSize(80)
      
      Text('è¯·å…ˆç™»å½•')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
      
      Text('ç™»å½•åå¯ä»¥æŸ¥çœ‹ä¸ªäººä¿¡æ¯å’Œç¯ä¿æ•°æ®')
        .fontSize(14)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
      
      Button('å»ç™»å½•')
        .width(200)
        .height(44)
        .backgroundColor('#4CAF50')
        .fontColor('#fff')
        .fontSize(16)
        .borderRadius(22)
        .onClick(() => {
          router.pushUrl({ url: 'pages/LoginPage' })
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .padding(40)
  }

  @Builder buildLogoutDialog() {
    Column() {
      Column({ space: 20 }) {
        Text('ç¡®è®¤é€€å‡º')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Text('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')
          .fontSize(14)
          .fontColor('#666')
        
        Row({ space: 15 }) {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showLogoutDialog = false
            })
          
          Button('ç¡®å®š')
            .layoutWeight(1)
            .backgroundColor('#FF5722')
            .fontColor('#fff')
            .onClick(async () => {
              await this.authService.logout()
              this.showLogoutDialog = false
              this.currentUser = null
              promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•' })
            })
        }
        .width('100%')
      }
      .width(280)
      .padding(20)
      .backgroundColor('#fff')
      .borderRadius(12)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0,0,0,0.5)')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.showLogoutDialog = false
    })
  }

  @Builder buildEditDialog() {
    Column() {
      Column({ space: 20 }) {
        Text('ç¼–è¾‘ä¸ªäººä¿¡æ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Column({ space: 15 }) {
          Column({ space: 8 }) {
            Text('ç”¨æˆ·å')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .alignSelf(ItemAlign.Start)
            
            TextInput({ text: this.editUsername })
              .onChange((value: string) => {
                this.editUsername = value
              })
          }
          .alignItems(HorizontalAlign.Start)
          .width('100%')
          
          Column({ space: 8 }) {
            Text('é€‰æ‹©å¤´åƒ')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .alignSelf(ItemAlign.Start)
            
            Grid() {
              ForEach(this.avatarOptions, (avatar: string) => {
                GridItem() {
                  Text(avatar)
                    .fontSize(24)
                    .width(40)
                    .height(40)
                    .backgroundColor(this.editAvatar === avatar ? '#E8F5E8' : '#f8f8f8')
                    .borderRadius(20)
                    .textAlign(TextAlign.Center)
                    .border({
                      width: this.editAvatar === avatar ? 2 : 0,
                      color: '#4CAF50'
                    })
                    .onClick(() => {
                      this.editAvatar = avatar
                    })
                }
              })
            }
            .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
            .rowsGap(8)
            .columnsGap(8)
          }
          .alignItems(HorizontalAlign.Start)
          .width('100%')
        }
        
        Row({ space: 15 }) {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .onClick(() => {
              this.showEditDialog = false
            })
          
          Button('ä¿å­˜')
            .layoutWeight(1)
            .backgroundColor('#4CAF50')
            .fontColor('#fff')
            .onClick(async () => {
              await this.saveUserInfo()
            })
        }
        .width('100%')
      }
      .width(320)
      .height(500)
      .padding(20)
      .backgroundColor('#fff')
      .borderRadius(12)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0,0,0,0.5)')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.showEditDialog = false
    })
  }

  private async loadUserData(forceRefresh: boolean = false) {
    try {
      this.isLoading = true;
      this.currentUser = await this.authService.getCurrentUser(forceRefresh);
      if (this.currentUser) {
        this.userRecords = await this.dataService.getUserRecords(this.currentUser.id);
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private async saveUserInfo() {
    if (!this.currentUser || !this.editUsername.trim()) {
      promptAction.showToast({ message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º' });
      return;
    }

    try {
      const updatedUser = new User(this.editUsername.trim(), this.currentUser.email, this.currentUser.password);
      updatedUser.id = this.currentUser.id;
      updatedUser.avatar = this.editAvatar;
      updatedUser.points = this.currentUser.points;
      updatedUser.level = this.currentUser.level;
      updatedUser.joinDate = this.currentUser.joinDate;
      updatedUser.carbonReduction = this.currentUser.carbonReduction;
      updatedUser.badges = this.currentUser.badges;
      
      await this.authService.updateUserInfo(updatedUser);
      this.currentUser = updatedUser;
      this.showEditDialog = false;
      
      // é€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°æ•°æ®
      AppStorage.Set('userDataUpdated', new Date().getTime());
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸ' });
      
      // ç›´æ¥è·³è½¬åˆ°é¦–é¡µï¼Œç¡®ä¿æ•°æ®åˆ·æ–°
      router.replaceUrl({ url: 'pages/Index' });
    } catch (error) {
      console.error('ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  private formatDate(dateStr: string): string {
    if (!dateStr) return 'æœªçŸ¥'
    const date = new Date(dateStr)
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`
  }

  private getBadgeIcon(badgeName: string): string {
    const iconMap: Record<string, string> = {
      'ç¯ä¿æ–°æ‰‹': 'ğŸŒ±',
      'ç¯ä¿è¾¾äºº': 'ğŸŒ¿',
      'ç¯ä¿ä¸“å®¶': 'ğŸŒ³',
      'ç¯ä¿å¤§ä½¿': 'ğŸ†',
      'ç¯ä¿å«å£«': 'ğŸ‘‘',
      'èŠ‚æ°´è¾¾äºº': 'ğŸ’§',
      'ä½ç¢³å‡ºè¡Œ': 'ğŸš²',
      'åƒåœ¾åˆ†ç±»': 'â™»ï¸',
      'æ¤æ ‘é€ æ—': 'ğŸŒ²',
      'æ¸…æ´æµ·æ´‹': 'ğŸŒŠ'
    }
    return iconMap[badgeName] || 'ğŸ…'
  }

  private getUserRanking(): string {
    // è¿™é‡Œåº”è¯¥ä»æ•°æ®æœåŠ¡è·å–å®é™…æ’å
    // æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
    return 'å‰10%'
  }
}