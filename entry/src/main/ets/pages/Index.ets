import { AuthService } from '../service/AuthService';
import { DataService } from '../service/DataService';
import { User, EcoRecord } from '../model/User';
import { router } from '@kit.ArkUI';
import { ActivitiesPage } from './ActivitiesPage';
import { RankingPage } from './RankingPage';
import { ProfilePage } from './ProfilePage';
import { CarbonCalculator } from '../service/CarbonCalculator';
import { RecordsPage } from './RecordPage';

@Entry
@Component
struct Index {
  @State index: number = 0;
  @State currentUser: User | null = null;
  @State isLoggedIn: boolean = false;
  @State userRecords: EcoRecord[] = [];

  private authService: AuthService = AuthService.getInstance();
  private dataService: DataService = DataService.getInstance();
  private carbonCalculator: CarbonCalculator = CarbonCalculator.getInstance();

  @Builder TabBarBuilder(title: string, selectIndex: number, selectEmoji: string, normalEmoji: string) {
    Column() {
      Text(this.index === selectIndex ? selectEmoji : normalEmoji)
        .fontSize(22)
        .margin({ top: 10 })
      Text(title)
        .margin({ top: 5 })
        .fontColor(this.index === selectIndex ? '#4CAF50' : '#6B6B6B')
        .fontSize(14)
    }
    .height(56)
    .width('100%')
  }

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®æœåŠ¡
    await this.dataService.init(getContext(this));

    // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
    await this.dataService.initSampleData();

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    await this.checkLoginStatus();
  }

  async onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶å¼ºåˆ¶åˆ·æ–°æ•°æ®
    await this.checkLoginStatus(true);
    
    // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®å¹¶ç¡®ä¿çŽ¯ä¿çŸ¥è¯†æ•°æ®æ­£ç¡®åŠ è½½
    await this.dataService.initSampleData();
  }

  async checkLoginStatus(forceRefresh: boolean = false) {
    this.currentUser = await this.authService.getCurrentUser(forceRefresh);
    this.isLoggedIn = this.currentUser !== null;
    if (this.currentUser) {
      await this.loadUserRecords();
    }
  }

  async loadUserRecords() {
    if (this.currentUser) {
      this.userRecords = await this.dataService.getEcoRecordsByUserId(this.currentUser.id);
    }
  }

  @Builder buildHomePage() {
    Scroll() {
      Column({ space: 15 }) {
        // ç”¨æˆ·æ¬¢è¿Žä¿¡æ¯
        Row() {
          Column({ space: 5 }) {
            Text(`ä½ å¥½ï¼Œ${this.currentUser?.username || 'çŽ¯ä¿è¾¾äºº'}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
            Text(`å½“å‰ç§¯åˆ†ï¼š${this.currentUser?.points || 0}`)
              .fontSize(14)
              .fontColor('#666')
          }
          .alignItems(HorizontalAlign.Start)

          Blank()

          Text(this.currentUser?.avatar || 'ðŸŒ±')
            .fontSize(40)
        }
        .width('100%')
        .padding(20)
        .backgroundColor('#fff')
        .borderRadius(10)

        // å¿«é€Ÿæ“ä½œ
        Row({ space: 15 }) {
          this.buildQuickAction('ðŸ“', 'è®°å½•çŽ¯ä¿', () => {
            router.pushUrl({ url: 'pages/AddRecordPage' });
          })
          this.buildQuickAction('ðŸŽ¯', 'å‚ä¸Žæ´»åŠ¨', () => {
            router.pushUrl({url: 'pages/ActivitiesPage'});
          })
          this.buildQuickAction('ðŸ“Š', 'æŸ¥çœ‹æŽ’å', () => {
            router.pushUrl({url: 'pages/RankingPage'});
          })
          this.buildQuickAction('ðŸ“š', 'çŽ¯ä¿çŸ¥è¯†', () => {
            router.pushUrl({ url: 'pages/KnowledgePage' });
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)

        // ä»Šæ—¥çŽ¯ä¿æç¤º
        Column({ space: 10 }) {
          Text('ðŸ’¡ ä»Šæ—¥çŽ¯ä¿å°è´´å£«')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
          Text('ä½¿ç”¨å¯é‡å¤æ°´ç“¶ï¼Œæ¯æ¬¡å¯å‡å°‘0.1kg COâ‚‚æŽ’æ”¾')
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#E8F5E8')
        .borderRadius(10)

        // æœ€æ–°æ´»åŠ¨é¢„è§ˆ
        Column({ space: 10 }) {
          Row() {
            Text('ðŸŽª æœ€æ–°æ´»åŠ¨')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
            Blank()
            Text('æŸ¥çœ‹æ›´å¤š >')
              .fontSize(12)
              .fontColor('#4CAF50')
              .onClick(() => {
                router.pushUrl({url: 'pages/ActivitiesPage'});
              })
          }
          .width('100%')

          Text('ç¤¾åŒºåžƒåœ¾åˆ†ç±»å¿—æ„¿æ´»åŠ¨')
            .fontSize(14)
            .fontColor('#333')
          Text('æ˜Žå¤© 09:00 | é˜³å…‰ç¤¾åŒºå¹¿åœº')
            .fontSize(12)
            .fontColor('#666')
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#fff')
        .borderRadius(10)
      }
      .padding(15)
    }
  }

  @Builder buildQuickAction(icon: string, title: string, action: () => void) {
    Column({ space: 8 }) {
      Text(icon)
        .fontSize(30)
      Text(title)
        .fontSize(12)
        .fontColor('#333')
    }
    .width(70)
    .height(70)
    .backgroundColor('#fff')
    .borderRadius(10)
    .justifyContent(FlexAlign.Center)
    .onClick(action)
  }

  @Builder buildLoginPage() {
    Column({ space: 20 }) {
      // Logoå’Œæ ‡é¢˜
      Column({ space: 10 }) {
        Text('ðŸŒ±')
          .fontSize(60)
        Text('çŽ¯ä¿å…¬ç›Š')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2E7D32')
        Text('è®©çŽ¯ä¿æˆä¸ºç”Ÿæ´»æ–¹å¼')
          .fontSize(16)
          .fontColor('#666')
      }
      .margin({ top: 100 })

      // ç™»å½•æŒ‰é’®
      Button('å¼€å§‹çŽ¯ä¿ä¹‹æ—…')
        .width('80%')
        .height(50)
        .backgroundColor('#4CAF50')
        .borderRadius(25)
        .fontSize(18)
        .onClick(() => {
          router.pushUrl({ url: 'pages/LoginPage' });
        })

      // æ³¨å†ŒæŒ‰é’®
      Button('æ–°ç”¨æˆ·æ³¨å†Œ')
        .width('80%')
        .height(50)
        .backgroundColor('#81C784')
        .borderRadius(25)
        .fontSize(18)
        .onClick(() => {
          router.pushUrl({ url: 'pages/RegisterPage' });
        })

      Blank()
    }
    .width('100%')
    .height('100%')
    .padding(20)
  }



  build() {
    if (this.isLoggedIn) {
      Tabs({ barPosition: BarPosition.End }) {
        TabContent() {
          // é¦–é¡µ
          this.buildHomePage()
        }
        .backgroundColor('#F1F3F5')
        .tabBar(this.TabBarBuilder('é¦–é¡µ', 0, 'ðŸ ', 'ðŸ¡'))

        TabContent() {
          // æ´»åŠ¨
          ActivitiesPage()
        }
        .backgroundColor('#F1F3F5')
        .tabBar(this.TabBarBuilder('æ´»åŠ¨', 1, 'ðŸŽ¯', 'ðŸš©'))

        TabContent() {
          // è®°å½•
          RecordsPage()
        }
        .backgroundColor('#F1F3F5')
        .tabBar(this.TabBarBuilder('è®°å½•', 2, 'ðŸ“Š', 'ðŸ“'))

        TabContent() {
          // æŽ’è¡Œ
          RankingPage()
        }
        .backgroundColor('#F1F3F5')
        .tabBar(this.TabBarBuilder('æŽ’è¡Œ', 3, 'ðŸ‘‘', 'ðŸ†'))

        TabContent() {
          // æˆ‘çš„
          ProfilePage()
        }
        .backgroundColor('#F1F3F5')
        .tabBar(this.TabBarBuilder('æˆ‘çš„', 4, 'ðŸ˜Š', 'ðŸ‘¤'))
      }
      .width('100%')
      .height('100%')
      .onChange((index: number) => {
        this.index = index
      })
    } else {
      this.buildLoginPage()
    }
  }
}