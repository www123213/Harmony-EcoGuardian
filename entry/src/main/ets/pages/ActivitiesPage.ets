import { DataService } from '../service/DataService';
import { AuthService } from '../service/AuthService';
import { EcoActivity } from '../model/User';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
export struct ActivitiesPage {
  @State activities: EcoActivity[] = []
  @State selectedFilter: string = 'å…¨éƒ¨'
  @State isLoading: boolean = true
  @State currentUserId: string = ''
  @State filteredActivities: EcoActivity[] = [];
  
  // ç›‘å¬æ´»åŠ¨æ•°æ®æ›´æ–°æ ‡å¿—
  @State activitiesUpdated: number = 0;
  
  private dataService: DataService = DataService.getInstance();
  private authService: AuthService = AuthService.getInstance();
  private filters: string[] = ['å…¨éƒ¨', 'å³å°†å¼€å§‹', 'è¿›è¡Œä¸­', 'å·²ç»“æŸ'];
  private activityTypes: string[] = ['å…¨éƒ¨', 'åƒåœ¾åˆ†ç±»', 'æ¤æ ‘é€ æ—', 'æµ·æ»©æ¸…ç†', 'ç¯ä¿æ•™è‚²'];

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®
    this.activitiesUpdated = 0;
    await this.loadData();
  }
  
  // æ·»åŠ é¡µé¢æ˜¾ç¤ºæ—¶çš„ç”Ÿå‘½å‘¨æœŸé’©å­
  async onPageShow() {
    console.log('ActivitiesPage: onPageShow åˆ·æ–°æ•°æ®');
    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°æ•°æ®
    if (this.activitiesUpdated > 0) {
      console.log('ActivitiesPage: æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œåˆ·æ–°æ´»åŠ¨åˆ—è¡¨');
    }
    await this.loadData();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Row() {
          Button('â† è¿”å›')
            .backgroundColor(Color.Transparent)
            .fontColor('#333')
            .height(40)
            .onClick(() => {
              router.back()
            })
        }
        .width('33%')
        .alignItems(VerticalAlign.Center)
        .justifyContent(FlexAlign.Start)

        Row() {
          Text('å…¬ç›Šæ´»åŠ¨')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
        }
        .width('34%')
        .alignItems(VerticalAlign.Center)
        .justifyContent(FlexAlign.Center)

        Row() {
          Button(){
            Text('+')
              .fontSize(24)
              .fontColor('#fff')
          }
          .width(30)
          .height(30)
          .backgroundColor('#4CAF50')
          .borderRadius(20)
          .onClick(() => {
            router.pushUrl({ url: 'pages/CreateActivityPage' });
          })
        }
        .width('33%')
        .alignItems(VerticalAlign.Center)
        .justifyContent(FlexAlign.End)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      Column() {
        // ç­›é€‰æ ‡ç­¾
        Scroll() {
          Row({ space: 10 }) {
            ForEach(this.filters, (filter: string) => {
              Text(filter)
                .fontSize(14)
                .fontColor(this.selectedFilter === filter ? '#fff' : '#333')
                .backgroundColor(this.selectedFilter === filter ? '#4CAF50' : '#f0f0f0')
                .padding({ top: 6, bottom: 6, left: 12, right: 12 })
                .borderRadius(15)
                .onClick(() => {
                  this.selectedFilter = filter
                  this.updateFilteredActivities()
                })
            })
          }
          .padding({ left: 16, right: 16 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
        .height(40)
        .margin({ top: 10 })

        // æ´»åŠ¨åˆ—è¡¨
        if (this.isLoading) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#666')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        } else if (this.filteredActivities.length === 0) {
          Column({ space: 20 }) {
            Text('ğŸ¯')
              .fontSize(60)
            Text('æš‚æ— æ´»åŠ¨')
              .fontSize(18)
              .fontColor('#666')
            Text('æˆä¸ºç¬¬ä¸€ä¸ªå‘èµ·æ´»åŠ¨çš„äººå§ï¼')
              .fontSize(14)
              .fontColor('#999')
            
            Button('å‘èµ·æ´»åŠ¨')
              .backgroundColor('#4CAF50')
              .borderRadius(20)
              .onClick(() => {
                router.pushUrl({ url: 'pages/CreateActivityPage' });
              })
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
        } else {
          List({ space: 15 }) {
            ForEach(this.filteredActivities, (activity: EcoActivity) => {
              ListItem() {
                this.buildActivityItem(activity)
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 10, bottom: 16 })
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder buildActivityItem(activity: EcoActivity) {
    Column({ space: 12 }) {
      // æ´»åŠ¨æ ‡é¢˜å’ŒçŠ¶æ€
      Row() {
        Text(activity.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
        
        Text(this.getActivityStatus(activity))
          .fontSize(12)
          .fontColor('#fff')
          .backgroundColor(this.getStatusColor(activity))
          .padding({ top: 4, bottom: 4, left: 8, right: 8 })
          .borderRadius(10)
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      // æ´»åŠ¨ç±»å‹å’Œç§¯åˆ†
      Row() {
        Text(`ğŸ·ï¸ ${activity.type}`)
          .fontSize(12)
          .fontColor('#4CAF50')
          .backgroundColor('#E8F5E8')
          .padding({ top: 4, bottom: 4, left: 8, right: 8 })
          .borderRadius(8)
        
        Blank()
        
        Text(`ğŸ ${activity.points}ç§¯åˆ†`)
          .fontSize(12)
          .fontColor('#FF9800')
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')

      // æ´»åŠ¨æè¿°
      Text(activity.description)
        .fontSize(14)
        .fontColor('#666')
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .lineHeight(20)

      // æ—¶é—´å’Œåœ°ç‚¹
      Column({ space: 6 }) {
        Row() {
          Text('ğŸ•')
            .fontSize(14)
          Text(`${this.formatDateTime(activity.startTime)} - ${this.formatDateTime(activity.endTime)}`)
            .fontSize(12)
            .fontColor('#666')
            .layoutWeight(1)
        }
        .width('100%')
        
        Row() {
          Text('ğŸ“')
            .fontSize(14)
          Text(activity.location)
            .fontSize(12)
            .fontColor('#666')
            .layoutWeight(1)
        }
        .width('100%')
      }

      // å‚ä¸äººæ•°å’Œæ“ä½œæŒ‰é’®
      Row() {
        Column({ space: 4 }) {
          Text(`${activity.currentParticipants}/${activity.maxParticipants}`)
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
          Text('å‚ä¸äººæ•°')
            .fontSize(10)
            .fontColor('#999')
        }
        
        Blank()
        
        Row({ space: 10 }) {
          Text(`${activity.isLikedByUser(this.currentUserId) ? 'â¤ï¸' : 'ğŸ¤'} ${activity.likes}`)
            .fontSize(12)
            .fontColor(activity.isLikedByUser(this.currentUserId) ? '#FF5722' : '#999')
            .onClick(() => {
              this.likeActivity(activity)
            })
          
          Text(`ğŸ’¬ ${activity.comments.length}`)
            .fontSize(12)
            .fontColor('#999')
            .onClick(() => {
              this.viewActivityDetail(activity)
            })
        }
        
        Blank()
        
        if (this.canParticipate(activity)) {
          Button('å‚ä¸')
            .height(32)
            .backgroundColor('#4CAF50')
            .borderRadius(16)
            .fontSize(12)
            .onClick(() => {
              this.participateActivity(activity)
            })
        } else if (this.isParticipating(activity)) {
          Button('å·²å‚ä¸')
            .height(32)
            .backgroundColor('#ccc')
            .borderRadius(16)
            .fontSize(12)
            .enabled(false)
        } else {
          Button('å·²æ»¡')
            .height(32)
            .backgroundColor('#f44336')
            .borderRadius(16)
            .fontSize(12)
            .enabled(false)
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .padding(15)
    .backgroundColor('#fff')
    .borderRadius(10)
    .onClick(() => {
      this.viewActivityDetail(activity)
    })
  }

  private async loadData() {
    try {
      // åˆå§‹åŒ–æ•°æ®æœåŠ¡
      await this.dataService.init(getContext(this))
      
      // è·å–å½“å‰ç”¨æˆ·ID
      const currentUser = await this.authService.getCurrentUser()
      this.currentUserId = currentUser?.id || ''
      
      // åŠ è½½æ´»åŠ¨æ•°æ®
      this.activities = await this.dataService.getEcoActivities()
      
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¹±ç æ•°æ®
      const hasCorruptedData = this.activities.some(activity => 
        !activity.title || activity.title.length > 50 || /^[0-9a-f]{10,}/.test(activity.title)
      );
      
      if (hasCorruptedData) {
        console.log('æ£€æµ‹åˆ°ä¹±ç æ•°æ®ï¼Œæ­£åœ¨æ¸…ç†...');
        await this.dataService.clearCorruptedActivityData();
        await this.dataService.initSampleData();
        this.activities = await this.dataService.getEcoActivities();
      }
      
      // æ›´æ–°æ´»åŠ¨çŠ¶æ€
      this.updateActivityStatus()
      
      // æ›´æ–°è¿‡æ»¤ç»“æœ
      this.updateFilteredActivities()
    } catch (error) {
      console.error('åŠ è½½æ´»åŠ¨æ•°æ®å¤±è´¥:', error)
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•' })
    } finally {
      this.isLoading = false;
    }
  }

  private updateActivityStatus() {
    const now = new Date()
    this.activities.forEach(activity => {
      if (now < activity.startTime) {
        activity.status = 'upcoming'
      } else if (now >= activity.startTime && now <= activity.endTime) {
        activity.status = 'ongoing'
      } else {
        activity.status = 'completed'
      }
    })
  }

  private updateFilteredActivities() {
    let filtered = this.activities

    if (this.selectedFilter !== 'å…¨éƒ¨') {
      switch (this.selectedFilter) {
        case 'å³å°†å¼€å§‹':
          filtered = filtered.filter(activity => activity.status === 'upcoming')
          break
        case 'è¿›è¡Œä¸­':
          filtered = filtered.filter(activity => activity.status === 'ongoing')
          break
        case 'å·²ç»“æŸ':
          filtered = filtered.filter(activity => activity.status === 'completed')
          break
        case 'æ¤æ ‘é€ æ—':
        case 'åƒåœ¾åˆ†ç±»':
        case 'èŠ‚èƒ½å‡æ’':
        case 'ç¯ä¿å®£ä¼ ':
          filtered = filtered.filter(activity => activity.type === this.selectedFilter)
          break
      }
    }

    // æŒ‰å¼€å§‹æ—¶é—´æ’åº
    this.filteredActivities = filtered.sort((a, b) => a.startTime.getTime() - b.startTime.getTime())
  }

  private getActivityStatus(activity: EcoActivity): string {
    switch (activity.status) {
      case 'upcoming':
        return 'å³å°†å¼€å§‹'
      case 'ongoing':
        return 'è¿›è¡Œä¸­'
      case 'completed':
        return 'å·²ç»“æŸ'
      default:
        return 'æœªçŸ¥'
    }
  }

  private getStatusColor(activity: EcoActivity): string {
    switch (activity.status) {
      case 'upcoming':
        return '#2196F3'
      case 'ongoing':
        return '#4CAF50'
      case 'completed':
        return '#9E9E9E'
      default:
        return '#9E9E9E'
    }
  }

  private canParticipate(activity: EcoActivity): boolean {
    return activity.status === 'upcoming' && 
           activity.currentParticipants < activity.maxParticipants &&
           !this.isParticipating(activity)
  }

  private isParticipating(activity: EcoActivity): boolean {
    return activity.participants.includes(this.currentUserId)
  }

  private async participateActivity(activity: EcoActivity) {
    if (!this.currentUserId) {
      promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' })
      router.pushUrl({ url: 'pages/LoginPage' })
      return
    }

    try {
      const success = activity.addParticipant(this.currentUserId)
      if (success) {
        await this.dataService.saveEcoActivity(activity)
        promptAction.showToast({ message: 'å‚ä¸æˆåŠŸï¼' })
        // åˆ·æ–°åˆ—è¡¨
        this.activities = [...this.activities]
        this.updateFilteredActivities()
      } else {
        promptAction.showToast({ message: 'å‚ä¸å¤±è´¥ï¼Œæ´»åŠ¨å¯èƒ½å·²æ»¡' })
      }
    } catch (error) {
      console.error('å‚ä¸æ´»åŠ¨å¤±è´¥:', error)
      promptAction.showToast({ message: 'å‚ä¸å¤±è´¥ï¼Œè¯·é‡è¯•' })
    }
  }

  private async likeActivity(activity: EcoActivity) {
    try {
      if (!this.currentUserId) {
        promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
        return;
      }

      // ä½¿ç”¨æ–°çš„toggleLikeæ–¹æ³•
      const isLiked = activity.toggleLike(this.currentUserId);

      await this.dataService.saveEcoActivity(activity);

      promptAction.showToast({
        message: isLiked ? 'ç‚¹èµæˆåŠŸï¼' : 'å·²å–æ¶ˆç‚¹èµ'
      });

      // åˆ·æ–°åˆ—è¡¨
      this.activities = [...this.activities];
      this.updateFilteredActivities();
    } catch (error) {
      console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
    }
  }

  private viewActivityDetail(activity: EcoActivity) {
    // ç®€åŒ–ç‰ˆè¯¦æƒ…æ˜¾ç¤º
    const detailInfo = `æ´»åŠ¨è¯¦æƒ…ï¼š\n\n${activity.description}\n\næ—¶é—´ï¼š${this.formatDateTime(activity.startTime)} - ${this.formatDateTime(activity.endTime)}\n\nåœ°ç‚¹ï¼š${activity.location}\n\nå‚ä¸äººæ•°ï¼š${activity.currentParticipants}/${activity.maxParticipants}\n\nç§¯åˆ†å¥–åŠ±ï¼š${activity.points}åˆ†`
    
    promptAction.showDialog({
      title: activity.title,
      message: detailInfo,
      buttons: [
        {
          text: 'å…³é—­',
          color: '#666'
        }
      ]
    })
  }

  private formatDateTime(date: Date): string {
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    const day = date.getDate().toString().padStart(2, '0')
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')
    return `${month}/${day} ${hours}:${minutes}`
  }
}