import { AuthService } from '../service/AuthService';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct LoginPage {
  @State email: string = '';
  @State password: string = '';
  @State isLoading: boolean = false;
  private authService: AuthService = AuthService.getInstance();

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .backgroundColor(Color.Transparent)
          .fontColor('#333')
          .onClick(() => {
            router.back();
          })
        
        Blank()
        
        Text('ç™»å½•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Text('')
          .width(60)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      // ç™»å½•è¡¨å•
      Column({ space: 20 }) {
        // Logo
        Column({ space: 10 }) {
          Text('ğŸŒ±')
            .fontSize(80)
          Text('æ¬¢è¿å›æ¥')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2E7D32')
          Text('ç»§ç»­ä½ çš„ç¯ä¿ä¹‹æ—…')
            .fontSize(16)
            .fontColor('#666')
        }
        .margin({ top: 60, bottom: 40 })

        // é‚®ç®±è¾“å…¥
        Column({ space: 8 }) {
          Text('é‚®ç®±')
            .fontSize(14)
            .fontColor('#333')
            .alignSelf(ItemAlign.Start)
          
          TextInput({ placeholder: 'è¯·è¾“å…¥é‚®ç®±åœ°å€' })
            .width('100%')
            .height(50)
            .backgroundColor('#f8f8f8')
            .borderRadius(8)
            .padding({ left: 16, right: 16 })
            .type(InputType.Email)
            .onChange((value: string) => {
              this.email = value;
            })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)

        // å¯†ç è¾“å…¥
        Column({ space: 8 }) {
          Text('å¯†ç ')
            .fontSize(14)
            .fontColor('#333')
            .alignSelf(ItemAlign.Start)
          
          TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ' })
            .width('100%')
            .height(50)
            .backgroundColor('#f8f8f8')
            .borderRadius(8)
            .padding({ left: 16, right: 16 })
            .type(InputType.Password)
            .onChange((value: string) => {
              this.password = value;
            })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)

        // ç™»å½•æŒ‰é’®
        Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
          .width('100%')
          .height(50)
          .backgroundColor('#4CAF50')
          .borderRadius(25)
          .fontSize(18)
          .fontColor('#fff')
          .enabled(!this.isLoading)
          .onClick(() => {
            this.handleLogin()
          })

        // æ³¨å†Œé“¾æ¥
        Row() {
          Text('è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ')
            .fontSize(14)
            .fontColor('#666')
          
          Text('ç«‹å³æ³¨å†Œ')
            .fontSize(14)
            .fontColor('#4CAF50')
            .onClick(() => {
              router.replaceUrl({ url: 'pages/RegisterPage' });
            })
        }
        .margin({ top: 20 })

        // å¿«é€Ÿç™»å½•æç¤º
        Column({ space: 10 }) {
          Text('ğŸ’¡ ä½“éªŒæç¤º')
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9800')
          Text('å¯ä»¥ä½¿ç”¨ä»»æ„é‚®ç®±å’Œå¯†ç æ³¨å†Œæ–°è´¦å·')
            .fontSize(12)
            .fontColor('#666')
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .padding(15)
        .backgroundColor('#FFF3E0')
        .borderRadius(8)
        .margin({ top: 30 })
      }
      .width('100%')
      .padding({ left: 30, right: 30 })
      .layoutWeight(1)

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  async handleLogin() {
    if (!this.email.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥é‚®ç®±' })
      return
    }

    if (!this.password.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥å¯†ç ' })
      return
    }

    this.isLoading = true;

    try {
      const result = await this.authService.login(this.email.trim(), this.password)
      
      if (result.success) {
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' })
        // è¿”å›ä¸»é¡µ
        router.replaceUrl({ url: 'pages/Index' })
      } else {
        promptAction.showToast({ message: result.message })
      }
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
      promptAction.showToast({ message: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•' })
    } finally {
      this.isLoading = false;
    }
  }
}