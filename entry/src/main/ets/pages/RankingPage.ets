import { DataService } from '../service/DataService';
import { AuthService } from '../service/AuthService';
import { CarbonCalculator } from '../service/CarbonCalculator';
import { User } from '../model/User';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

// å‹‹ç« æ¥å£
interface Badge {
  name: string;
  requirement: string;
  icon: string;
}

@Entry
@Component
export struct RankingPage {
  @State userRanking: User[] = [];
  @State currentUser: User | null = null;
  @State selectedTab: number = 0; // 0: ç§¯åˆ†æ’è¡Œ, 1: å‡æ’æ’è¡Œ, 2: å‹‹ç« å±•ç¤º
  @State isLoading: boolean = true;
  @State myRanking: number = 0;
  
  private dataService: DataService = DataService.getInstance();
  private authService: AuthService = AuthService.getInstance();
  private carbonCalculator: CarbonCalculator = CarbonCalculator.getInstance();
  private tabs: string[] = ['ç§¯åˆ†æ’è¡Œ', 'å‡æ’æ’è¡Œ', 'å‹‹ç« å±•ç¤º'];

  async aboutToAppear() {
    await this.loadRankingData();

    // åˆ›å»ºAppStorageç›‘å¬
    AppStorage.SetOrCreate('userDataUpdated', 0);
  }

  async onPageShow() {
    // é‡æ–°åŠ è½½æ’è¡Œæ¦œæ•°æ®
    this.currentUser = await this.authService.getCurrentUser(true); // å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·æ•°æ®
    await this.loadRankingData();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â† è¿”å›')
          .backgroundColor(Color.Transparent)
          .fontColor('#333')
          .onClick(() => {
            router.back();
          })
        
        Blank()
        
        Text('æ’è¡Œæ¦œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text('')
          .width(60)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#fff')

      Column() {
        // æ ‡ç­¾åˆ‡æ¢
        Row() {
          ForEach(this.tabs, (tab: string, index: number) => {
            Text(tab)
              .fontSize(16)
              .fontColor(this.selectedTab === index ? '#4CAF50' : '#666')
              .fontWeight(this.selectedTab === index ? FontWeight.Bold : FontWeight.Normal)
              .padding({ top: 10, bottom: 10 })
              .layoutWeight(1)
              .textAlign(TextAlign.Center)
              .onClick(() => {
                this.selectedTab = index;
              })
          })
        }
        .width('100%')
        .backgroundColor('#fff')
        .border({ width: { bottom: 1 }, color: '#e0e0e0' })

        // æˆ‘çš„æ’åå¡ç‰‡
        if (this.currentUser && this.myRanking > 0) {
          this.buildMyRankingCard()
        }

        // æ’è¡Œæ¦œå†…å®¹
        if (this.isLoading) {
          Column() {
            Text('åŠ è½½ä¸­...')
              .fontSize(16)
              .fontColor('#666')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        } else {
          if (this.selectedTab === 0) {
            this.buildPointsRanking()
          } else if (this.selectedTab === 1) {
            this.buildCarbonRanking()
          } else {
            this.buildBadgesDisplay()
          }
        }
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  @Builder buildMyRankingCard() {
    Column({ space: 10 }) {
      Text('æˆ‘çš„æ’å')
        .fontSize(14)
        .fontColor('#666')
      
      Row() {
        Text(this.currentUser?.avatar || 'ğŸŒ±')
          .fontSize(30)
        
        Column({ space: 4 }) {
          Text(this.currentUser?.username || '')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
          
          if (this.selectedTab === 0) {
            Text(`${this.currentUser?.points || 0} ç§¯åˆ†`)
              .fontSize(14)
              .fontColor('#4CAF50')
          } else {
            Text(this.carbonCalculator.formatCarbonReduction(this.currentUser?.carbonReduction || 0))
              .fontSize(14)
              .fontColor('#4CAF50')
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 10 })
        
        Column({ space: 4 }) {
          Text(`ç¬¬${this.myRanking}å`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9800')
          Text('å½“å‰æ’å')
            .fontSize(12)
            .fontColor('#999')
        }
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
    }
    .width('100%')
    .padding(15)
    .backgroundColor('#FFF3E0')
    .borderRadius(10)
    .margin({ left: 16, right: 16, top: 10 })
  }

  @Builder buildPointsRanking() {
    List({ space: 8 }) {
      ForEach(this.userRanking, (user: User, index: number) => {
        ListItem() {
          this.buildRankingItem(user, index + 1, 'points')
        }
      })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ left: 16, right: 16, top: 10, bottom: 16 })
  }

  @Builder buildCarbonRanking() {
    List({ space: 8 }) {
      ForEach(this.getCarbonRanking(), (user: User, index: number) => {
        ListItem() {
          this.buildRankingItem(user, index + 1, 'carbon')
        }
      })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ left: 16, right: 16, top: 10, bottom: 16 })
  }

  @Builder buildBadgesDisplay() {
    Scroll() {
      Column({ space: 20 }) {
        // æˆ‘çš„å‹‹ç« 
        if (this.currentUser && this.currentUser.badges.length > 0) {
          Column({ space: 10 }) {
            Text('æˆ‘çš„å‹‹ç« ')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .alignSelf(ItemAlign.Start)
            
            Grid() {
              ForEach(this.currentUser.badges, (badge: string) => {
                GridItem() {
                  this.buildBadgeItem(badge, true)
                }
              })
            }
            .columnsTemplate('1fr 1fr 1fr')
            .rowsGap(10)
            .columnsGap(10)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
        }

        // æ‰€æœ‰å‹‹ç« 
        Column({ space: 10 }) {
          Text('å‹‹ç« ç³»ç»Ÿ')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .alignSelf(ItemAlign.Start)
          
          Text('é€šè¿‡ç¯ä¿è¡Œä¸ºè·å¾—ä¸åŒç­‰çº§çš„å‹‹ç« ')
            .fontSize(12)
            .fontColor('#666')
            .alignSelf(ItemAlign.Start)
          
          Grid() {
            ForEach(this.getAllBadges(), (badge: Badge) => {
              GridItem() {
                this.buildBadgeItem(badge.name, this.currentUser?.badges.includes(badge.name) || false, badge.requirement, badge.icon)
              }
            })
          }
          .columnsTemplate('1fr 1fr')
          .rowsGap(15)
          .columnsGap(15)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
      .padding(16)
    }
    .layoutWeight(1)
  }

  @Builder buildRankingItem(user: User, rank: number, type: string) {
    Row() {
      // æ’å
      Text(rank.toString())
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getRankColor(rank))
        .width(40)
        .textAlign(TextAlign.Center)
      
      // å¤´åƒ
      Text(user.avatar || 'ğŸŒ±')
        .fontSize(24)
        .margin({ left: 10, right: 10 })
      
      // ç”¨æˆ·ä¿¡æ¯
      Column({ space: 4 }) {
        Text(user.username)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
        
        Text(`ç­‰çº§ ${user.level}`)
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // ç§¯åˆ†æˆ–å‡æ’é‡
      Column({ space: 4 }) {
        if (type === 'points') {
          Text(`${user.points}`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4CAF50')
          Text('ç§¯åˆ†')
            .fontSize(12)
            .fontColor('#999')
        } else {
          Text(this.carbonCalculator.formatCarbonReduction(user.carbonReduction))
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4CAF50')
          Text('å‡æ’é‡')
            .fontSize(12)
            .fontColor('#999')
        }
      }
      .alignItems(HorizontalAlign.End)
      
      // æ’åå›¾æ ‡
      if (rank <= 3) {
        Text(this.getRankIcon(rank))
          .fontSize(20)
          .margin({ left: 10 })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor(user.id === this.currentUser?.id ? '#E8F5E8' : '#fff')
    .borderRadius(10)
    .border({
      width: user.id === this.currentUser?.id ? 2 : 0,
      color: '#4CAF50'
    })
  }

  @Builder buildBadgeItem(badgeName: string, earned: boolean, requirement?: string, icon?: string) {
    Column({ space: 8 }) {
      Text(icon || this.getBadgeIcon(badgeName))
        .fontSize(30)
        .opacity(earned ? 1 : 0.3)
      
      Text(badgeName)
        .fontSize(12)
        .fontWeight(FontWeight.Bold)
        .fontColor(earned ? '#333' : '#999')
        .textAlign(TextAlign.Center)
      
      if (requirement) {
        Text(requirement)
          .fontSize(10)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .maxLines(2)
      }
    }
    .width('100%')
    .padding(10)
    .backgroundColor(earned ? '#E8F5E8' : '#f8f8f8')
    .borderRadius(8)
    .border({
      width: earned ? 2 : 1,
      color: earned ? '#4CAF50' : '#e0e0e0'
    })
  }

  private async loadRankingData() {
    try {
      // è·å–å½“å‰ç”¨æˆ·
      this.currentUser = await this.authService.getCurrentUser()
      
      // è·å–ç§¯åˆ†æ’è¡Œæ¦œ
      this.userRanking = await this.dataService.getPointsRanking()
      
      // è®¡ç®—æˆ‘çš„æ’å
      if (this.currentUser) {
        this.myRanking = this.userRanking.findIndex(user => user.id === this.currentUser?.id) + 1;
      }
    } catch (error) {
      console.error('åŠ è½½æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', error)
      promptAction.showToast({ message: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•' })
    } finally {
      this.isLoading = false;
    }
  }

  private getCarbonRanking(): User[] {
    return [...this.userRanking].sort((a, b) => b.carbonReduction - a.carbonReduction);
  }

  private getRankColor(rank: number): string {
    switch (rank) {
      case 1:
        return '#FFD700' // é‡‘è‰²
      case 2:
        return '#C0C0C0' // é“¶è‰²
      case 3:
        return '#CD7F32' // é“œè‰²
      default:
        return '#666'
    }
  }

  private getRankIcon(rank: number): string {
    switch (rank) {
      case 1:
        return 'ğŸ¥‡'
      case 2:
        return 'ğŸ¥ˆ'
      case 3:
        return 'ğŸ¥‰'
      default:
        return ''
    }
  }

  private getBadgeIcon(badgeName: string): string {
    const iconMap: Record<string, string> = {
      'ç¯ä¿æ–°æ‰‹': 'ğŸŒ±',
      'ç¯ä¿è¾¾äºº': 'ğŸŒ¿',
      'ç¯ä¿ä¸“å®¶': 'ğŸŒ³',
      'ç¯ä¿å¤§ä½¿': 'ğŸ†',
      'ç¯ä¿å«å£«': 'ğŸ‘‘',
      'èŠ‚æ°´è¾¾äºº': 'ğŸ’§',
      'ä½ç¢³å‡ºè¡Œ': 'ğŸš²',
      'åƒåœ¾åˆ†ç±»': 'â™»ï¸',
      'æ¤æ ‘é€ æ—': 'ğŸŒ²',
      'æ¸…æ´æµ·æ´‹': 'ğŸŒŠ'
    }
    return iconMap[badgeName] || 'ğŸ…';
  }

  private getAllBadges(): Badge[] {
    const badges: Badge[] = [
      { name: 'ç¯ä¿æ–°æ‰‹', requirement: 'å‡æ’10kg COâ‚‚', icon: 'ğŸŒ±' },
      { name: 'ç¯ä¿è¾¾äºº', requirement: 'å‡æ’50kg COâ‚‚', icon: 'ğŸŒ¿' },
      { name: 'ç¯ä¿ä¸“å®¶', requirement: 'å‡æ’100kg COâ‚‚', icon: 'ğŸŒ³' },
      { name: 'ç¯ä¿å¤§ä½¿', requirement: 'å‡æ’500kg COâ‚‚', icon: 'ğŸ†' },
      { name: 'ç¯ä¿å«å£«', requirement: 'å‡æ’1000kg COâ‚‚', icon: 'ğŸ‘‘' },
      { name: 'èŠ‚æ°´è¾¾äºº', requirement: 'èŠ‚æ°´è¡Œä¸º20æ¬¡', icon: 'ğŸ’§' },
      { name: 'ä½ç¢³å‡ºè¡Œ', requirement: 'ç»¿è‰²å‡ºè¡Œ50æ¬¡', icon: 'ğŸš²' },
      { name: 'åƒåœ¾åˆ†ç±»', requirement: 'åƒåœ¾åˆ†ç±»30æ¬¡', icon: 'â™»ï¸' },
      { name: 'æ¤æ ‘é€ æ—', requirement: 'ç§æ¤æ ‘æœ¨10æ£µ', icon: 'ğŸŒ²' },
      { name: 'æ¸…æ´æµ·æ´‹', requirement: 'å‚ä¸æ¸…æ´æ´»åŠ¨5æ¬¡', icon: 'ğŸŒŠ' }
    ];
    return badges;
  }
}